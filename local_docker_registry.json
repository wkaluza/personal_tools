{
  "configs": {
    "nginx_config": {
      "file": "${NGINX_CONFIG:?}",
      "name": "local_docker_registry_nginx_config_${NGINX_CONFIG_DIGEST:?}"
    }
  },
  "networks": {
    "frontend": {},
    "internal": {}
  },
  "services": {
    "docker_registry": {
      "build": {
        "context": "${PROJECT_ROOT_DIR:?}/registry",
        "dockerfile": "${PROJECT_ROOT_DIR:?}/registry/registry.dockerfile",
        "network": "none"
      },
      "deploy": {
        "mode": "global",
        "placement": {
          "constraints": [
            "node.id==${LOCAL_NODE_ID:?}"
          ]
        },
        "restart_policy": {
          "condition": "on-failure",
          "delay": "10s",
          "max_attempts": 5,
          "window": "120s"
        },
        "rollback_config": {
          "delay": "10s",
          "failure_action": "pause",
          "max_failure_ratio": 0,
          "monitor": "10s",
          "order": "start-first",
          "parallelism": 1
        },
        "update_config": {
          "delay": "10s",
          "failure_action": "rollback",
          "max_failure_ratio": 0,
          "monitor": "10s",
          "order": "start-first",
          "parallelism": 1
        }
      },
      "image": "${DOCKER_REGISTRY_IMAGE_REFERENCE:?}",
      "networks": [
        "internal"
      ],
      "volumes": [
        {
          "source": "local_registry_volume",
          "target": "/var/lib/registry",
          "type": "volume"
        }
      ]
    },
    "reverse_proxy": {
      "build": {
        "context": "${PROJECT_ROOT_DIR:?}/reverse_proxy",
        "dockerfile": "${PROJECT_ROOT_DIR:?}/reverse_proxy/reverse_proxy.dockerfile",
        "network": "none"
      },
      "configs": [
        {
          "source": "nginx_config",
          "target": "/etc/nginx/nginx.conf"
        }
      ],
      "depends_on": [
        "docker_registry"
      ],
      "deploy": {
        "mode": "global",
        "placement": {
          "constraints": [
            "node.id==${LOCAL_NODE_ID:?}"
          ]
        },
        "restart_policy": {
          "condition": "on-failure",
          "delay": "10s",
          "max_attempts": 5,
          "window": "120s"
        },
        "rollback_config": {
          "delay": "10s",
          "failure_action": "pause",
          "max_failure_ratio": 0,
          "monitor": "10s",
          "order": "start-first",
          "parallelism": 1
        },
        "update_config": {
          "delay": "10s",
          "failure_action": "rollback",
          "max_failure_ratio": 0,
          "monitor": "10s",
          "order": "start-first",
          "parallelism": 1
        }
      },
      "image": "${REVERSE_PROXY_IMAGE_REFERENCE:?}",
      "networks": [
        "frontend",
        "internal"
      ],
      "ports": [
        "80:80"
      ]
    }
  },
  "version": "3.9",
  "volumes": {
    "local_registry_volume": {}
  }
}
